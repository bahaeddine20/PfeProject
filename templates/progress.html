<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ex√©cution des Tests</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .progress-container {
            margin: 2rem 0;
        }
        .button-group {
            margin: 1.5rem 0;
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
    </style>
</head>
<body class="container mt-5">
    <div class="text-center">
        <h2 class="mb-4">‚è≥ Ex√©cution des tests...</h2>

        <div id="spinner" class="spinner-border text-primary my-3" role="status">
            <span class="visually-hidden">En cours...</span>
        </div>

        <h4 id="test-name" class="my-3">Initialisation...</h4>

        <div class="progress-container">
            <div class="progress" style="height: 30px;">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                     role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
            <small id="progress-text" class="text-muted">0% compl√©t√© (0/0 tests)</small>
        </div>

        <div class="button-group">
            <button id="stop-btn" class="btn btn-danger" onclick="stopExecution()">üõë Stop</button>
            <button id="cancel-btn" class="btn btn-secondary" onclick="cancelExecution()">‚ùå Annuler</button>
            <a id="back-button" href="{{ url_for('home') }}" class="btn btn-success d-none">Retour √† l'accueil</a>
            <a id="download-btn" href="{{ url_for('download_results') }}" class="btn btn-primary d-none">üì• T√©l√©charger les r√©sultats</a>
        </div>
    </div>

    <script>
        function updateProgress() {
            fetch("/progress")
                .then(response => {
                    if (!response.ok) throw new Error("Erreur r√©seau");
                    return response.json();
                })
                .then(data => {
                    console.log("Mise √† jour des donn√©es :", data);

                    // Mise √† jour de la progression
                    document.getElementById("test-name").textContent = data.current_file;

                    const progressBar = document.getElementById("progress-bar");
                    progressBar.style.width = data.percentage + "%";
                    progressBar.textContent = data.percentage + "%";
                    progressBar.setAttribute("aria-valuenow", data.percentage);

                    // Mise √† jour du texte de progression
                    const progressText = document.getElementById("progress-text");
                    progressText.textContent = `${data.percentage}% compl√©t√© (${data.completed || 0}/${data.total || 0} tests)`;

                    if (data.percentage < 100 && !data.current_file.includes("üõë")) {
                        setTimeout(updateProgress, 1000);
                    } else {
                        finalizeProgress(data);
                    }
                })
                .catch(error => {
                    console.error("Erreur de mise √† jour :", error);
                    document.getElementById("test-name").textContent = "Erreur de connexion au serveur";
                    setTimeout(updateProgress, 3000); // R√©essayer apr√®s 3 secondes
                });
        }

        function finalizeProgress(data) {
            document.getElementById("spinner").classList.add("d-none");
            document.getElementById("stop-btn").classList.add("d-none");
            document.getElementById("cancel-btn").classList.add("d-none");
            document.getElementById("back-button").classList.remove("d-none");

            // Afficher le bouton de t√©l√©chargement si les tests sont termin√©s avec succ√®s
            if (data.percentage === 100 && !data.current_file.includes("üõë") && !data.current_file.includes("Erreur")) {
                document.getElementById("download-btn").classList.remove("d-none");
            }
        }

        function stopExecution() {
            if (confirm("√ätes-vous s√ªr de vouloir arr√™ter l'ex√©cution des tests ?")) {
                fetch("/stop_tests", { method: "POST" })
                    .then(response => {
                        if (!response.ok) throw new Error("Erreur lors de l'arr√™t");
                        return response.json();
                    })
                    .then(data => {
                        document.getElementById("test-name").textContent = data.message;
                        document.getElementById("progress-bar").style.width = "100%";
                        document.getElementById("progress-bar").textContent = "100%";
                        finalizeProgress({percentage: 100, current_file: data.message});
                    })
                    .catch(error => {
                        console.error("Erreur lors de l'arr√™t :", error);
                        alert("Une erreur est survenue lors de l'arr√™t des tests");
                    });
            }
        }

        function cancelExecution() {
            if (confirm("√ätes-vous s√ªr de vouloir annuler et revenir √† l'accueil ?")) {
                window.location.href = "/";
            }
        }

        // D√©marrer la mise √† jour de la progression lorsque la page est charg√©e
        document.addEventListener("DOMContentLoaded", updateProgress);
    </script>
</body>
</html>